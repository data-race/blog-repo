---
title: Linux是怎样工作的2 进程的创建
date: 2023-07-17 20:17:25
tags: [linux]
---
#linux 

## 创建进程
在Linux中，创建进程有两个目的
- 将同一个程序分为多个进程进行处理，例如Web服务器处理多个请求
- 创建另一个程序，例如从bash启动一个新的程序

为了达成这个目的，Linux提供了`fork`和`execve`函数，其底层对应`clone`和`execve`两个系统调用
我们可以可以查看这两个系统调用的说明

## 创建进程的过程
1. 为子进程分配内存空间，将父进程内存拷贝到子进程的内存中
2. fork() 函数返回不同的返回值给父子进程，父进程会得到子进程的进程号，也就是pid，而子进程的返回值为0
![](img/41038254-11FC-4BD2-84BB-F15B88161E23.png
)

从fork恢复后，父子进程分别判断fork的返回值，进行不同的动作。虽然子进程拷贝了父进程的内存空间，但是仍需要注意以下
- 子进程不会继承父进程的内存锁(mlock)
- 子进程的资源吞吐量和CPU时间计数器会被重置为0
- 子进程不会继承父进程的信号量调整(semaphore adjustment)
- 还有更多可以参考`man fork`

## 启动一个进程
启动一个进程时，需要执行`execve`函数，它执行以下操作
- 读取可执行文件，并读取创建进程的内存映像所需的信息
- 用新进程的数据覆盖当前进程的内存
- 从最初的命令开始运行新进程

也就是说在使用execve时，并没有创建新的进程，而是用新进程替换了当前的进程。
![](img/249CAB24-1325-45E2-98FD-505D561CD458.png
)

## Fork-and-execve
再打算创建一个别的进程时，通常采用fork-and-execve的方式，由父进程调用fork创建子进程，再由子进程执行execve运行新进程。例如我们在bash中执行可执行文件，就是采用的这个方式。

在golang或者python这种高级语言中，提供了各自风格的多进程多线程操作。比如golang提供了goroutine风格的协程并发，python提供了multiprocessing多进程包，但是他们的底层也离不开这些系统调用的支持。


